name: Upload Python Package

on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine
    - name: Build and publish
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: |
        set -euo pipefail
        python setup.py sdist bdist_wheel
        python <<'PY'
import json
import re
import sys
import urllib.error
import urllib.request
from pathlib import Path

package = "django_readers"
version = None
init_path = Path(package) / "__init__.py"
pattern = re.compile(r"__version__\s*=\s*['\"]([^'\"]+)['\"]")
for line in init_path.read_text().splitlines():
    match = pattern.search(line)
    if match:
        version = match.group(1)
        break

if not version:
    print("Unable to determine package version", file=sys.stderr)
    sys.exit(1)

filename = f"{package}-{version}-py3-none-any.whl"
url = f"https://pypi.org/pypi/{package.replace('_', '-')}/{version}/json"

try:
    with urllib.request.urlopen(url) as response:
        metadata = json.load(response)
except urllib.error.HTTPError as exc:
    if exc.code == 404:
        print(f"{package} {version} not yet on PyPI; wheel will be uploaded.")
        raise SystemExit(0)
    raise
else:
    published = {file["filename"] for file in metadata.get("urls", [])}
    if filename in published:
        wheel_path = Path("dist") / filename
        if wheel_path.exists():
            wheel_path.unlink()
            print(f"Wheel already on PyPI, removed local copy: {filename}")
    else:
        print("Wheel not yet on PyPI; will upload freshly built wheel.")
PY
        if compgen -G "dist/*.whl" > /dev/null; then
          twine upload dist/*.whl
        else
          echo "No wheel to upload (already published)."
        fi
        twine upload dist/*.tar.gz
